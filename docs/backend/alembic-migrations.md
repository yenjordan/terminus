# Database Migrations with Alembic

Alembic is a lightweight database migration tool for SQLAlchemy. It allows you to manage changes to your database schema over time in a structured and version-controlled way.

## Why Use Alembic?

*   **Version Control for Your Database:** Track schema changes alongside your application code.
*   **Repeatable Deployments:** Ensure consistent database schemas across different environments (development, staging, production).
*   **Collaboration:** Makes it easier for multiple developers to work on database schema changes without conflicts.
*   **Automated Schema Changes:** Avoids manual SQL scripting for schema modifications, reducing errors.

## Core Concepts

*   **Migration Environment:** A directory (usually named `alembic` or `alembic` in your backend root) containing Alembic's configuration and migration scripts.
*   **`alembic.ini`:** The main configuration file for Alembic. It specifies database connection details, script locations, and other settings.
*   **`env.py`:** A Python script within the migration environment that Alembic executes when running commands. It's where you configure how Alembic connects to your database and how it discovers your SQLAlchemy models for autogeneration.
    *   Crucially, `env.py` needs to know about your SQLAlchemy models' metadata (`target_metadata = Base.metadata`).
*   **Revision:** A single migration script representing a set of changes to the database schema. Each revision has a unique ID.
*   **`upgrade()` function:** Contains the operations to apply the schema changes (e.g., create a table, add a column).
*   **`downgrade()` function:** Contains the operations to revert the schema changes.

## Setting Up Alembic (If not already set up)

If Alembic is not yet part of the project, you would typically initialize it:

1.  Install Alembic: `pip install alembic`
2.  Initialize the environment (from your `backend` directory):
    ```bash
    alembic init alembic
    ```
    (This creates a `alembic` directory and an `alembic.ini` file.)
3.  Configure `alembic.ini` with your database URL (`sqlalchemy.url`).
4.  Configure `alembic/env.py`:
    *   Ensure `target_metadata` points to your SQLAlchemy `Base.metadata` from `app.db.base` or wherever your models are defined.
    *   Ensure the Python path is set up so `env.py` can import your application modules.

## Common Alembic Commands

Run these commands from the directory containing `alembic.ini` (usually your `backend` root).

### 1. Generating a New Migration Script

When you make changes to your SQLAlchemy models (e.g., add a new model, add a column to an existing model), you need to generate a migration script.

**Manual Revision (Recommended for understanding):**
```bash
alembic revision -m "create_users_table"
```
This creates a new, empty migration file in `alembic/versions/`. You then manually edit this file to define the `upgrade()` and `downgrade()` functions using Alembic's `op` object.

**Example (Manual - creating a users table):**
```python
# In the generated migration_xyz.py file
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = 'your_revision_id'
down_revision = 'previous_revision_id_or_None'
branch_labels = None
depends_on = None

def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.Integer, primary_key=True, index=True),
        sa.Column('email', sa.String, unique=True, index=True, nullable=False),
        sa.Column('hashed_password', sa.String, nullable=False),
        sa.Column('is_active', sa.Boolean, default=True)
    )

def downgrade():
    op.drop_table('users')
```

**Autogenerate Revision (Use with caution and always review):**
Alembic can compare your SQLAlchemy models against the current database state and attempt to generate the migration script automatically.

```bash
alembic revision -m "add_bio_to_users" --autogenerate
```
*   **Important:** Always review autogenerated scripts carefully. Alembic might not detect all changes perfectly (e.g., complex constraints, server defaults, changes to types that are not straightforward). You might need to manually adjust the script.

### 2. Applying Migrations

To apply pending migrations to your database:

*   **Apply all pending migrations (upgrade to the latest revision):**
    ```bash
    alembic upgrade head
    ```
*   **Apply migrations up to a specific revision:**
    ```bash
    alembic upgrade <revision_id>
    ```
*   **Apply a single next migration:**
    ```bash
    alembic upgrade +1
    ```

### 3. Reverting Migrations (Downgrading)

To undo migrations:

*   **Revert the last applied migration:**
    ```bash
    alembic downgrade -1
    ```
*   **Revert migrations down to a specific revision:**
    ```bash
    alembic downgrade <target_revision_id>
    ```
*   **Revert all migrations (to an empty database state, if applicable):**
    ```bash
    alembic downgrade base
    ```
    **(Use with extreme caution on production data!)**

### 4. Viewing Migration Status

*   **Show current revision(s) and migration history:**
    ```bash
    alembic history
    ```
*   **Show the current revision ID(s) the database is at:**
    ```bash
    alembic current
    ```
*   **Show all revisions, indicating which are applied:**
    ```bash
    alembic history --verbose
    ```

## Best Practices

*   **Keep Migrations Small and Focused:** Each migration should represent a single, logical change.
*   **Test Migrations:** Always test your migrations in a development or staging environment before applying them to production.
*   **Never Edit an Applied Migration:** Once a migration has been applied to a shared database (like production), do not edit its script. Instead, create a new migration to correct or alter it.
*   **Backup Your Database:** Before running significant migrations on production, always back up your database.
*   **Review Autogenerated Scripts:** Thoroughly inspect any script generated with `--autogenerate`.
*   **Consider Data Migrations Separately:** For changes that involve transforming data (not just schema), you might write custom Python code within your migration script or handle it as a separate process. Alembic's `op.bulk_insert` and `op.execute` can be useful here.

## Further Reading

*   [Alembic Official Tutorial](https://alembic.sqlalchemy.org/en/latest/tutorial.html)
*   [Alembic Operation Reference](https://alembic.sqlalchemy.org/en/latest/ops.html)
